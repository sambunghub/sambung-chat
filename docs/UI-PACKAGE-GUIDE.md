# UI Package Development Guide - @sambung-chat/ui

A dedicated guide for developing the `@sambung-chat/ui` package to avoid common build issues.

---

## Package Structure

```
packages/ui/
├── src/
│   ├── lib/                    # ✅ ALL code MUST be here
│   │   ├── components/
│   │   │   ├── ui/            # shadcn-svelte components
│   │   │   ├── layout/        # Custom layout components
│   │   │   ├── auth/          # Auth components
│   │   │   └── markdown/      # Markdown components
│   │   ├── stores/            # Svelte stores
│   │   ├── styles/            # Global styles
│   │   ├── cn.ts              # Class name utility
│   │   ├── utils.ts           # Utilities
│   │   └── index.ts           # Main export
│   ├── styles/
│   │   └── index.css          # CSS variables & Tailwind base
│   └── tokens/                # Design tokens
├── dist/                      # Generated by svelte-package
├── tailwind.config.js         # Tailwind configuration
└── package.json
```

---

## Golden Rules

### 1. Code MUST be in `src/lib/`

**CRITICAL:** `svelte-package` only builds the `src/lib/` folder. Files outside this folder will NOT be included in distribution.

```
❌ DON'T:
packages/ui/src/components/auth/
packages/ui/src/utils/
packages/ui/src/hooks/

✅ DO:
packages/ui/src/lib/components/auth/
packages/ui/src/lib/utils/
packages/ui/src/lib/hooks/
```

### 2. No @apply with Custom Colors in <style>

Tailwind CSS v4 **does not support** `@apply` with custom color utilities in `<style>` blocks:

```svelte
<!-- ❌ DON'T - Will fail build -->
<style>
  .my-class {
    @apply bg-primary text-primary-foreground;
  }
</style>

<!-- ✅ DO - Use CSS variables -->
<style>
  .my-class {
    background-color: hsl(var(--color-primary));
    color: hsl(var(--color-primary-foreground));
  }
</style>
```

### 3. Always Use @lucide/svelte

Package dependency uses `@lucide/svelte` (with scope), NOT `lucide-svelte`:

```typescript
// ❌ DON'T
import { Search, Plus } from 'lucide-svelte';

// ✅ DO
import { Search, Plus } from '@lucide/svelte';
```

### 4. $state Requires let

All reactive state with `$state()` must use `let`:

```svelte
<script lang="ts">
  // ❌ DON'T
  const count = $state(0);
  const items = $state([]);

  // ✅ DO
  let count = $state(0);
  let items = $state([]);
</script>
```

---

## Creating New Components

### Step 1: Create Component File

Place in `src/lib/components/[category]/`:

```bash
# Example: New button component
packages/ui/src/lib/components/button/Button.svelte
```

### Step 2: Component Template

```svelte
<script lang="ts">
  import { cn } from '../../utils';
  import type { HTMLButtonAttributes } from 'svelte/elements';

  interface Props extends HTMLButtonAttributes {
    variant?: 'default' | 'destructive' | 'outline' | 'ghost';
    size?: 'default' | 'sm' | 'lg' | 'icon';
    class?: string;
    children?: import('svelte').Snippet;
  }

  let {
    variant = 'default',
    size = 'default',
    class: className,
    children,
    ...restProps
  }: Props = $props();

  const baseClass =
    'inline-flex items-center justify-center rounded-md font-medium transition-colors';
  const variantClass = {
    default: 'bg-primary text-primary-foreground hover:bg-primary/90',
    destructive: 'bg-destructive text-destructive-foreground hover:bg-destructive/90',
    outline: 'border border-input bg-background hover:bg-accent hover:text-accent-foreground',
    ghost: 'hover:bg-accent hover:text-accent-foreground',
  }[variant];
  const sizeClass = {
    default: 'h-10 px-4 py-2',
    sm: 'h-9 rounded-md px-3',
    lg: 'h-11 rounded-md px-8',
    icon: 'h-10 w-10',
  }[size];
</script>

<button class={cn(baseClass, variantClass, sizeClass, className)} {...restProps}>
  {#if children}
    {@render children()}
  {/if}
</button>
```

### Step 3: Create Barrel Export

`packages/ui/src/lib/components/button/index.ts`:

```typescript
export { default as Button } from './Button.svelte';
export type { Props as ButtonProps } from './Button.svelte';
```

### Step 4: Export from Main Index

Add to `packages/ui/src/lib/index.ts`:

```typescript
export * from './components/button/index';
```

### Step 5: Rebuild Package

```bash
cd packages/ui
bun run build
```

---

## Working with Styles

### CSS Variables Available

```css
/* From packages/ui/src/styles/index.css */

/* Semantic Colors */
--color-background
--color-foreground
--color-card
--color-card-foreground
--color-popover
--color-popover-foreground
--color-primary
--color-primary-foreground
--color-secondary
--color-secondary-foreground
--color-muted
--color-muted-foreground
--color-accent
--color-accent-foreground
--color-destructive
--color-destructive-foreground

/* UI Elements */
--color-border
--color-input
--color-ring

/* Border Radius */
--radius
```

### Using CSS Variables

```svelte
<style>
  .custom-element {
    /* Background */
    background-color: hsl(var(--color-background));
    background-color: hsl(var(--color-primary));

    /* Text */
    color: hsl(var(--color-foreground));
    color: hsl(var(--color-muted-foreground));

    /* Border */
    border: 1px solid hsl(var(--color-border));
    border-radius: var(--radius);

    /* Focus ring */
    outline: none;
    box-shadow: 0 0 0 2px hsl(var(--color-ring));
  }
</style>
```

### Component-Specific Styles

For styles specific to a component:

```svelte
<div class="custom-class" />
<div class={cn('base-class', className)} />

<style>
  .custom-class {
    /* Use CSS variables, not @apply */
    color: hsl(var(--color-muted-foreground));
  }
</style>
```

---

## Common Patterns

### Pattern 1: Compound Component

```svelte
<!-- Card.svelte -->
<script lang="ts">
  import { cn } from '../../utils';
  import type { Snippet } from 'svelte';

  interface Props {
    class?: string;
    children?: Snippet;
  }

  let { class: className, children }: Props = $props();
</script>

<div class={cn('bg-card text-card-foreground rounded-lg border shadow-sm', className)}>
  {#if children}
    {@render children()}
  {/if}
</div>
```

### Pattern 2: Forward Ref

```svelte
<script lang="ts">
  import type { HTMLButtonElement } from 'svelte/elements';

  interface Props {
    ref?: HTMLButtonElement;
  }

  let { ref = $bindable(null) }: Props = $props();
</script>

<button bind:this={ref} />
```

### Pattern 3: Conditional Styling

```svelte
<script lang="ts">
  import { cn } from '../../utils';

  interface Props {
    variant?: 'primary' | 'secondary';
    class?: string;
  }

  let { variant = 'primary', class: className }: Props = $props();

  const variantClasses = {
    primary: 'bg-primary text-primary-foreground',
    secondary: 'bg-secondary text-secondary-foreground',
  };
</script>

<div class={cn(variantClasses[variant], className)} />
```

### Pattern 4: Reactive State

```svelte
<script lang="ts">
  import type { HTMLInputElement } from 'svelte/elements';

  // State with $state
  let count = $state(0);
  let items = $state<string[]>([]);
  let inputRef = $state<HTMLInputElement | undefined>(undefined);

  // Derived state
  let doubled = $derived(count * 2);

  // Effects
  $effect(() => {
    console.log('Count changed:', count);
  });
</script>
```

---

## Tailwind Configuration

### Adding New Plugins

Edit `packages/ui/tailwind.config.js`:

```javascript
export default {
  darkMode: ['class'],
  content: ['./src/**/*.{html,js,svelte,ts}'],
  theme: {
    extend: {
      /* ... */
    },
  },
  plugins: [
    require('tw-animate-css'),
    // Add more plugins here
  ],
};
```

### Custom Tailwind Utilities

For custom utilities, add to theme:

```javascript
theme: {
  extend: {
    // Custom colors
    colors: {
      custom: {
        50: 'hsl(...)',
        // ...
      }
    },
    // Custom spacing
    spacing: {
      '128': '32rem',
    }
  }
}
```

---

## Export Best Practices

### Main Export File (`src/lib/index.ts`)

```typescript
// Utilities
export { cn } from './cn';
export * from './utils';

// Component Groups
export * from './components/ui/index';
export * from './components/layout/index';
export * from './components/auth/index';
export * from './components/markdown/index';

// Stores
export * from './stores/index';
```

### Category Export File (`src/lib/components/ui/index.ts`)

```typescript
// Re-export all UI components
export * from './button/index';
export * from './input/index';
export * from './dialog/index';
```

### Component Export File (`src/lib/components/button/index.ts`)

```typescript
export { default as Button } from './Button.svelte';

// Optional: Export types
export type { Props as ButtonProps } from './Button.svelte';
```

---

## Testing Locally

### 1. Build Package

```bash
cd packages/ui
bun run build
```

### 2. Link Package (if needed)

```bash
cd packages/ui
bun link

cd apps/web
bun link @sambung-chat/ui
```

### 3. Import in App

```svelte
<!-- apps/web/src/routes/+page.svelte -->
<script lang="ts">
  import { Button } from '@sambung-chat/ui';
</script>

<Button>Click me</Button>
```

### 4. Check Build

```bash
# Build entire monorepo
bun run build

# Or just web app
cd apps/web
bun run build
```

---

## Debugging Tips

### Check Built Output

```bash
# See what's in dist
ls -la packages/ui/dist/

# Check specific file
cat packages/ui/dist/index.js

# Verify exports
cat packages/ui/package.json | grep -A 20 '"exports"'
```

### Find Import Usages

```bash
# Find all lucide imports
rg "from ['\"]lucide" packages/ui/src

# Find all @apply usage
rg "@apply" packages/ui/src

# Find component definitions
rg "export.*Component" packages/ui/src
```

### Type Checking

```bash
# Type check UI package
cd packages/ui
bun run check

# Type check entire monorepo
bun run check:types
```

---

## Pre-Commit Checklist

Before modifying the UI package:

- [ ] Component file in `src/lib/components/`
- [ ] Export path in `src/lib/index.ts` is relative and correct
- [ ] No `@apply` with custom colors
- [ ] Lucide imports use `@lucide/svelte`
- [ ] `$state` variables use `let`
- [ ] Package builds successfully: `bun run build`
- [ ] Type check passes: `bun run check`
- [ ] Web app build passes: `cd ../apps/web && bun run build`

---

## Quick Reference

| Issue                                | Solution                             |
| ------------------------------------ | ------------------------------------ |
| `Cannot apply unknown utility class` | Use CSS variables, not `@apply`      |
| `Could not resolve import`           | Check package name in `package.json` |
| `Cannot assign to constant`          | Use `let` with `$state()`            |
| Export not in dist                   | File must be in `src/lib/`           |
| Conflicting exports                  | Use alias or rename export           |

---

## Related Documentation

- [Main Troubleshooting Guide](./TROUBLESHOOTING.md)
- [Svelte 5 Docs](https://svelte.dev/docs/runes)
- [Tailwind CSS v4](https://tailwindcss.com/docs/v4-beta)
- [shadcn-svelte](https://www.shadcn-svelte.com/)
