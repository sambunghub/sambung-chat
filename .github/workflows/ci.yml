name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# IMPORTANT: All jobs must pass before merging to develop
# These jobs are required status checks for branch protection

jobs:
  # PR title check - fastest, no dependencies (runs on PR only)
  pr-title-check:
    name: PR Title Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
            revert
          scopes: |
            web
            server
            api
            db
            auth
            ui
            config
            env
          requireScope: false
          # Custom error message with examples
          error: |
            PR title format is invalid. Please use conventional commit format.

            Examples of valid PR titles:
            - fix: resolve build error
            - feat: add user authentication
            - docs: update API documentation
            - refactor: optimize database queries
            - feat(web): add responsive layout
            - fix(api): handle edge case in login

            Format: <type>: <description>
            - Use lowercase type (fix, not Fix)
            - Use colon : after type (not /)
            - Optional scope in parentheses: <type>(<scope>): <description>

            For more info: https://www.conventionalcommits.org/

  # Type check - fast, no dependencies
  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Type check
        run: bun run check-types

  # Lint - fast, no dependencies
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Lint
        run: bun run lint

  # Unit tests - medium, depends on type-check, lint
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [type-check, lint]
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Wait for PostgreSQL
        run: |
          for i in {1..30}; do
            if pg_isready -h localhost -p 5432 -U test; then
              echo "PostgreSQL is ready"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 1
          done

      - name: Setup database
        run: |
          cd packages/db
          bunx drizzle-kit push --config=drizzle.config.ts
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test

      - name: Run unit tests
        run: bun run test:unit
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          ENCRYPTION_KEY: 6zntUQJc/2ah8bfoSky0ttJmfBvAKHs1n+DGykcXW1E=
          BETTER_AUTH_SECRET: test-secret-minimum-32-characters-long
          BETTER_AUTH_URL: http://localhost:3000
          BETTER_AUTH_CLIENT_ID: test-client-id
          CORS_ORIGIN: http://localhost:5174
          PUBLIC_SERVER_URL: http://localhost:3000
          PUBLIC_API_URL: http://localhost:3000

  # Build - slowest, depends on type-check, lint
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [type-check, lint]
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build
        env:
          PUBLIC_SERVER_URL: http://localhost:3000

  # E2E tests - disabled
  # NOTE: Temporarily disabled due to timeout issues
  # TODO: Re-enable after fixing preview server setup
  # test-e2e:
  #   name: E2E Tests
  #   runs-on: ubuntu-latest
  #   needs: [build]
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - uses: oven-sh/setup-bun@v2
  #       with:
  #         bun-version: latest
  #
  #     - name: Install dependencies
  #       run: bun install
  #
  #     - name: Install Playwright browsers
  #       run: bunx playwright install --with-deps
  #
  #     - name: Run E2E tests
  #       run: bun run test:e2e
  #
  #     - name: Upload Playwright report
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: playwright-report
  #         path: playwright-report/
  #         retention-days: 7

  # E2E tests
  # NOTE: Temporarily disabled due to timeout issues
  # TODO: Re-enable after fixing preview server setup
  # test-e2e:
  #   name: E2E Tests
  #   runs-on: ubuntu-latest
  #   needs: [build]
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - uses: oven-sh/setup-bun@v2
  #       with:
  #         bun-version: latest
  #
  #     - name: Install dependencies
  #       run: bun install
  #
  #     - name: Install Playwright browsers
  #       run: bunx playwright install --with-deps
  #
  #     - name: Run E2E tests
  #       run: bun run test:e2e
  #
  #     - name: Upload Playwright report
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: playwright-report
  #         path: playwright-report/
  #         retention-days: 7
